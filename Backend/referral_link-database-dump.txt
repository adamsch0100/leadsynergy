-- This script was generated by the ERD tool in pgAdmin 4.
-- Please log an issue at https://github.com/pgadmin-org/pgadmin4/issues/new/choose if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS public.activities
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    lead_id uuid NOT NULL,
    user_id uuid NOT NULL,
    type text COLLATE pg_catalog."default" NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT activities_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.activities
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.commission_submissions
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    lead_id uuid,
    agent_id uuid,
    property_address text COLLATE pg_catalog."default" NOT NULL,
    contract_date date NOT NULL,
    closing_date date NOT NULL,
    commission_percentage numeric(5, 2) NOT NULL,
    commission_amount numeric(12, 2) NOT NULL,
    proof_document_url text COLLATE pg_catalog."default" NOT NULL,
    notes text COLLATE pg_catalog."default",
    submitted_at timestamp with time zone NOT NULL DEFAULT now(),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT commission_submissions_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.commission_submissions
    ENABLE ROW LEVEL SECURITY;

COMMENT ON TABLE public.commission_submissions
    IS 'Stores details submitted for closed deal commissions.';

CREATE TABLE IF NOT EXISTS public.fub_source_analyses
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    "timestamp" timestamp with time zone NOT NULL,
    total_leads integer NOT NULL,
    unique_sources integer NOT NULL,
    leads_without_source integer NOT NULL,
    sources jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    CONSTRAINT fub_source_analyses_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.fub_source_analyses
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.id
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    error_type text COLLATE pg_catalog."default" DEFAULT ''::text,
    "timestamp" timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text),
    error_message text COLLATE pg_catalog."default" DEFAULT ''::text,
    metadata jsonb DEFAULT '{}'::jsonb,
    CONSTRAINT id_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.id
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.lead_assignments
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    lead_id uuid,
    user_id uuid,
    assignment_type text COLLATE pg_catalog."default" NOT NULL,
    assigned_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    CONSTRAINT lead_assignments_pkey PRIMARY KEY (id),
    CONSTRAINT lead_assignments_lead_id_user_id_key UNIQUE (lead_id, user_id)
);

ALTER TABLE IF EXISTS public.lead_assignments
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.lead_notes
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    lead_id uuid NOT NULL,
    agent_id uuid,
    subject text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    note_id bigint NOT NULL,
    metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
    created_by text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    updated_by text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    body text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    replies jsonb,
    created_by_id uuid,
    updated_by_id text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    fub_note_id text COLLATE pg_catalog."default",
    CONSTRAINT lead_notes_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.lead_notes
    ENABLE ROW LEVEL SECURITY;

COMMENT ON COLUMN public.lead_notes.note_id
    IS 'This the ID of the note from FUB and is different from id because once we create a note from FUB, the id will stay the same even after updating it';

COMMENT ON COLUMN public.lead_notes.created_by
    IS 'Actual name of agent who made the note';

COMMENT ON COLUMN public.lead_notes.updated_by
    IS 'Actual name of agent who updated the note';

COMMENT ON COLUMN public.lead_notes.replies
    IS 'Replies from other agents for the note';

CREATE TABLE IF NOT EXISTS public.lead_source_settings
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    source_name text COLLATE pg_catalog."default" NOT NULL,
    referral_fee_percentage integer,
    metadata jsonb DEFAULT '{}'::jsonb,
    assignment_rules jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    fub_stage_mapping jsonb NOT NULL,
    options jsonb NOT NULL,
    is_active boolean NOT NULL,
    assignment_strategy assignment_type DEFAULT 'specific'::assignment_type,
    last_sync_attempt_at timestamp with time zone,
    CONSTRAINT lead_source_settings_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.lead_source_settings
    ENABLE ROW LEVEL SECURITY;

COMMENT ON COLUMN public.lead_source_settings.last_sync_attempt_at
    IS 'Timestamp of the last time the system attempted to sync leads for this source.';

CREATE TABLE IF NOT EXISTS public.lead_updates
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    lead_id uuid,
    user_id uuid,
    status text COLLATE pg_catalog."default" NOT NULL,
    notes text COLLATE pg_catalog."default",
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    CONSTRAINT lead_updates_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.lead_updates
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.leads
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    email text COLLATE pg_catalog."default",
    first_name text COLLATE pg_catalog."default",
    last_name text COLLATE pg_catalog."default",
    phone text COLLATE pg_catalog."default",
    source text COLLATE pg_catalog."default",
    status text COLLATE pg_catalog."default" DEFAULT 'new'::text,
    fub_person_id text COLLATE pg_catalog."default",
    notes text COLLATE pg_catalog."default",
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    tags text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    stage_id text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    price numeric NOT NULL DEFAULT '0'::numeric,
    assigned_agent_id uuid,
    lead_source_id uuid,
    organization_id uuid,
    CONSTRAINT leads_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.leads
    ENABLE ROW LEVEL SECURITY;

COMMENT ON COLUMN public.leads.price
    IS 'The price of the house inquiry of the lead';

COMMENT ON COLUMN public.leads.assigned_agent_id
    IS 'The ID of the user (agent) this lead is currently assigned to.';

CREATE TABLE IF NOT EXISTS public.organization_users
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    organization_id uuid NOT NULL DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL DEFAULT gen_random_uuid(),
    role text COLLATE pg_catalog."default" NOT NULL DEFAULT '''member'''::text,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT organization_users_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.organization_users
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.organizations
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    name text COLLATE pg_catalog."default",
    slug text COLLATE pg_catalog."default" NOT NULL,
    subscription_status text COLLATE pg_catalog."default" NOT NULL DEFAULT '"trial"'::text,
    subscription_plan text COLLATE pg_catalog."default" NOT NULL DEFAULT '"basic"'::text,
    subsciption_end_date timestamp with time zone NOT NULL DEFAULT now(),
    billing_email text COLLATE pg_catalog."default",
    settings jsonb,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT organizations_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.organizations
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.reminders
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    lead_id uuid,
    user_id uuid,
    reminder_date timestamp with time zone NOT NULL,
    description text COLLATE pg_catalog."default",
    status text COLLATE pg_catalog."default" DEFAULT 'pending'::text,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    CONSTRAINT reminders_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.reminders
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.settings
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    fub_api_key text COLLATE pg_catalog."default",
    fub_import_tag text COLLATE pg_catalog."default" DEFAULT 'ReferralLink'::text,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    CONSTRAINT settings_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.settings
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.stage_change_logs
(
    created_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text),
    lead_id text COLLATE pg_catalog."default",
    fub_person_id bigint,
    previous_stage text COLLATE pg_catalog."default",
    new_stage text COLLATE pg_catalog."default",
    "timestamp" timestamp with time zone,
    webhook_data jsonb,
    mapping_result jsonb,
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    CONSTRAINT stage_change_logs_pkey PRIMARY KEY (id)
);

ALTER TABLE IF EXISTS public.stage_change_logs
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.stage_mappings
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid DEFAULT auth.uid(),
    source_id uuid,
    fub_stage_id text COLLATE pg_catalog."default" NOT NULL,
    fub_stage_name text COLLATE pg_catalog."default" NOT NULL,
    platform text COLLATE pg_catalog."default" NOT NULL,
    platform_stage_name jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    metadata jsonb,
    lead_id uuid NOT NULL DEFAULT gen_random_uuid(),
    is_completed boolean NOT NULL DEFAULT false,
    CONSTRAINT stage_mappings_pkey PRIMARY KEY (id),
    CONSTRAINT stage_mappings_user_id_fub_stage_id_platform_key UNIQUE (user_id, fub_stage_id, platform)
);

ALTER TABLE IF EXISTS public.stage_mappings
    ENABLE ROW LEVEL SECURITY;

COMMENT ON COLUMN public.stage_mappings.metadata
    IS 'The metadata for the stage mapping';

CREATE TABLE IF NOT EXISTS public.system_settings
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    fub_api_key text COLLATE pg_catalog."default",
    fub_api_key_set boolean DEFAULT false,
    webhook_url text COLLATE pg_catalog."default",
    min_update_interval_days integer DEFAULT 5,
    max_update_interval_days integer DEFAULT 10,
    fub_import_tag text COLLATE pg_catalog."default",
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT system_settings_pkey PRIMARY KEY (id)
);

COMMENT ON TABLE public.system_settings
    IS 'Stores system-wide configuration settings.';

CREATE TABLE IF NOT EXISTS public.user_profiles
(
    id uuid NOT NULL,
    email text COLLATE pg_catalog."default" NOT NULL,
    full_name text COLLATE pg_catalog."default",
    phone_number text COLLATE pg_catalog."default",
    role text COLLATE pg_catalog."default" NOT NULL DEFAULT 'agent'::text,
    fub_api_key text COLLATE pg_catalog."default",
    fub_import_tag text COLLATE pg_catalog."default" DEFAULT 'ReferralLink'::text,
    onboarding_completed boolean DEFAULT false,
    email_notifications boolean DEFAULT true,
    sms_notifications boolean DEFAULT true,
    timezone text COLLATE pg_catalog."default" DEFAULT 'America/Denver'::text,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
    CONSTRAINT user_profiles_pkey PRIMARY KEY (id),
    CONSTRAINT user_profiles_email_key UNIQUE (email)
);

ALTER TABLE IF EXISTS public.user_profiles
    ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.users
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    first_name text COLLATE pg_catalog."default" NOT NULL,
    email text COLLATE pg_catalog."default" NOT NULL,
    phone_number text COLLATE pg_catalog."default",
    role user_role NOT NULL DEFAULT 'agent'::user_role,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    fub_account_id text COLLATE pg_catalog."default",
    last_name text COLLATE pg_catalog."default" NOT NULL DEFAULT ''::text,
    full_name text COLLATE pg_catalog."default" NOT NULL,
    email_notifications boolean DEFAULT false,
    sms_notifications boolean DEFAULT false,
    CONSTRAINT users_pkey PRIMARY KEY (id),
    CONSTRAINT users_email_key UNIQUE (email)
);

ALTER TABLE IF EXISTS public.users
    ENABLE ROW LEVEL SECURITY;

ALTER TABLE IF EXISTS public.commission_submissions
    ADD CONSTRAINT commission_submissions_agent_id_fkey FOREIGN KEY (agent_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_commission_submissions_agent_id
    ON public.commission_submissions(agent_id);


ALTER TABLE IF EXISTS public.commission_submissions
    ADD CONSTRAINT commission_submissions_lead_id_fkey FOREIGN KEY (lead_id)
    REFERENCES public.leads (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_commission_submissions_lead_id
    ON public.commission_submissions(lead_id);


ALTER TABLE IF EXISTS public.lead_assignments
    ADD CONSTRAINT lead_assignments_lead_id_fkey FOREIGN KEY (lead_id)
    REFERENCES public.leads (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_lead_assignments_lead_id
    ON public.lead_assignments(lead_id);


ALTER TABLE IF EXISTS public.lead_notes
    ADD CONSTRAINT lead_notes_created_by_id_fkey FOREIGN KEY (created_by_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_lead_notes_created_by_id
    ON public.lead_notes(created_by_id);


ALTER TABLE IF EXISTS public.lead_notes
    ADD CONSTRAINT lead_notes_lead_id_fkey FOREIGN KEY (lead_id)
    REFERENCES public.leads (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_lead_notes_lead_id
    ON public.lead_notes(lead_id);


ALTER TABLE IF EXISTS public.lead_updates
    ADD CONSTRAINT lead_updates_lead_id_fkey FOREIGN KEY (lead_id)
    REFERENCES public.leads (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.leads
    ADD CONSTRAINT leads_assigned_agent_id_fkey FOREIGN KEY (assigned_agent_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_leads_assigned_agent_id
    ON public.leads(assigned_agent_id);


ALTER TABLE IF EXISTS public.leads
    ADD CONSTRAINT leads_lead_source_id_fkey FOREIGN KEY (lead_source_id)
    REFERENCES public.lead_source_settings (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_leads_lead_source_id
    ON public.leads(lead_source_id);


ALTER TABLE IF EXISTS public.leads
    ADD CONSTRAINT leads_organization_id_fkey FOREIGN KEY (organization_id)
    REFERENCES public.organizations (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.organization_users
    ADD CONSTRAINT organization_users_organization_id_fkey FOREIGN KEY (organization_id)
    REFERENCES public.organizations (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.organization_users
    ADD CONSTRAINT organization_users_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.reminders
    ADD CONSTRAINT reminders_lead_id_fkey FOREIGN KEY (lead_id)
    REFERENCES public.leads (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_reminders_lead_id
    ON public.reminders(lead_id);


ALTER TABLE IF EXISTS public.stage_mappings
    ADD CONSTRAINT stage_mappings_lead_id_fkey FOREIGN KEY (lead_id)
    REFERENCES public.leads (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.stage_mappings
    ADD CONSTRAINT stage_mappings_source_id_fkey FOREIGN KEY (source_id)
    REFERENCES public.lead_source_settings (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_stage_mappings_source_id
    ON public.stage_mappings(source_id);

END;